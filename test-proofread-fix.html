<!DOCTYPE html>
<html lang="zh-CN">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校对修复测试</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }

      .test-case {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
      }

      .test-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }

      .test-description {
        color: #666;
        margin-bottom: 15px;
        font-size: 0.9em;
      }

      .test-content {
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        white-space: pre-wrap;
      }

      .error-highlight {
        background-color: #ffe6e6;
        padding: 2px 4px;
        border-radius: 3px;
        border: 1px solid #ff9999;
      }

      .success-highlight {
        background-color: #e6ffe6;
        padding: 2px 4px;
        border-radius: 3px;
        border: 1px solid #99ff99;
      }

      .fix-info {
        font-size: 0.85em;
        color: #888;
        margin-top: 5px;
      }

      .status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        margin-left: 10px;
      }

      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .code-block {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 10px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <h1>校对功能修复测试</h1>
    <p>这个页面展示了校对功能中偏移量计算问题的修复情况。</p>

    <div class="test-case">
      <div class="test-title">
        测试用例 1: 段落级错误合并
        <span class="status success">已修复</span>
      </div>
      <div class="test-description">
        当同一段落中有多个错误时，系统会将整个段落作为一个错误处理，避免多次替换导致的偏移量问题。
      </div>
      <div class="test-content">
        <p>这是一个<span class="error-highlight">错</span>误的示例，其中包含<span class="error-highlight">错</span>误的单词。</p>
        <p>这是另一个段落，没有错误。</p>
      </div>
      <div class="fix-info">
        修复前：可能只替换第一个"错"字，或者因为偏移量计算错误导致替换失败<br>
        修复后：将整个段落作为一个错误处理，一次性替换所有错误
      </div>
      <div class="code-block">
        修复逻辑：
        1. 按段落分割文本
        2. 对每个段落进行纠错
        3. 如果段落中有多个错误，合并为段落级错误
        4. 使用段落索引（行号）定位具体段落
        5. 在目标段落中进行精确替换
      </div>
    </div>

    <div class="test-case">
      <div class="test-title">
        测试用例 2: 精确段落定位
        <span class="status success">已修复</span>
      </div>
      <div class="test-description">
        修复了替换时可能匹配到错误段落的问题，现在会根据行号或光标位置精确定位到目标段落。
      </div>
      <div class="test-content">
        <p>第一段：这里有一个<span class="error-highlight">错</span>误。</p>
        <p>第二段：这里也有一个<span class="error-highlight">错</span>误。</p>
        <p>第三段：这是正确的文本。</p>
      </div>
      <div class="fix-info">
        修复前：点击第二段的错误，可能替换到第一段的相同错误<br>
        修复后：根据行号精确定位到第二段，只替换该段落中的错误
      </div>
      <div class="code-block">
        定位逻辑：
        1. 如果有行号信息：使用行号直接定位到具体段落
        2. 如果没有行号：使用光标位置确定当前段落
        3. 在目标段落中查找并替换文本
        4. 如果无法确定目标段落，才回退到全局搜索
      </div>
    </div>

    <div class="test-case">
      <div class="test-title">
        测试用例 3: 光标位置保持
        <span class="status success">已修复</span>
      </div>
      <div class="test-description">
        修复了替换后光标位置丢失的问题，确保用户体验的连续性。
      </div>
      <div class="test-content">
        <p>用户在这一段中输入文字，然后进行校对。</p>
        <p>校对完成后，光标应该保持在合理的位置。</p>
      </div>
      <div class="fix-info">
        修复前：替换后光标可能跳到文档开头或其他位置<br>
        修复后：保存光标位置，替换完成后恢复到正确位置
      </div>
      <div class="code-block">
        光标管理：
        1. 替换前保存光标在纯文本中的偏移量
        2. 执行文本替换操作
        3. 替换完成后根据偏移量恢复光标位置
        4. 触发编辑器保存机制
      </div>
    </div>

    <div class="test-case">
      <div class="test-title">
        核心修复代码 - 基于字符偏移量
        <span class="status success">已实现</span>
      </div>
      <div class="test-description">
        这是修复后的核心逻辑代码，基于字符偏移量进行精确定位。
      </div>
      <div class="code-block">
        function handleProofreadFix(issueOrOriginal: any, corrected?: string) {
        // 1. 获取编辑器中的纯文本内容
        const editorText = editorRef.value.getBodyText()

        // 2. 使用字符偏移量精确定位
        if (position !== null && position >= 0) {
        const walker = document.createTreeWalker(bodyElement, NodeFilter.SHOW_TEXT, null)
        let currentNode: Text | null
        let currentOffset = 0

        while (currentNode = walker.nextNode() as Text) {
        const nodeText = currentNode.textContent || ''
        const nodeLength = nodeText.length

        // 检查目标位置是否在这个节点中
        if (position >= currentOffset && position < currentOffset + nodeLength) { // 计算在这个节点中的相对位置 const relativePosition=position - currentOffset // 检查这个位置开始的文本是否匹配originalText if (nodeText.substring(relativePosition, relativePosition + originalText.length)===originalText) { // 执行替换 const beforeText=nodeText.substring(0, relativePosition) const afterText=nodeText.substring(relativePosition + originalText.length) currentNode.textContent=beforeText + correctedText + afterText break } } currentOffset +=nodeLength } } } </div>
      </div>
      <div class="test-description">
        修复了以下关键问题：
      </div>
      <ul>
        <li><span class="success-highlight">✅ 段落级错误合并</span>：避免同一段落多次替换导致的偏移量错误</li>
        <li><span class="success-highlight">✅ 精确段落定位</span>：根据行号或光标位置准确定位目标段落</li>
        <li><span class="success-highlight">✅ 光标位置保持</span>：替换后正确恢复光标位置</li>
        <li><span class="success-highlight">✅ 回退机制</span>：无法确定目标段落时的安全回退</li>
      </ul>
      <div class="fix-info">
        这些修复确保了校对功能的稳定性和准确性，用户可以放心使用"应用"按钮来修复错误。
      </div>
    </div>
  </body>

</html>

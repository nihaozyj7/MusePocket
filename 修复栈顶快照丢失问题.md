# 修复"栈顶快照丢失"问题

## 问题描述

运行时出现以下错误：
```
history.service.ts:88 栈顶快照丢失
HistorySidebar.vue:82 无法重建历史版本内容
```

## 根本原因

在 `saveNewVersion` 函数中，操作顺序错误导致的：

### 原来的错误顺序：
1. 生成 diff
2. **清除旧栈顶的快照** ← 问题在这里
3. 创建新的栈顶记录

**问题**：在步骤 2 和 3 之间，如果有任何代码读取历史记录（比如点击历史版本侧边栏），会发现栈顶没有快照，导致错误。

### 另一个问题：

`clearOldTopSnapshot` 函数的逻辑错误：
- 它获取"当前栈顶"并清除其快照
- 但在调用它时，新记录已经是栈顶了
- 结果：清除了新记录的快照，而不是旧记录！

## 修复方案

### 1. 调整操作顺序

**新的正确顺序**：
1. 生成 diff
2. **创建新的栈顶记录**（带有 fullContent）
3. **清除第二条记录的快照**（原来的栈顶）

这样确保：
- 始终有一条记录带有 fullContent
- 避免出现"栈顶快照丢失"的情况

### 2. 修复 clearOldTopSnapshot 逻辑

```typescript
async clearOldTopSnapshot(articleId: string): Promise<Status> {
  const histories = await this.getArticleHistories(articleId)

  // 如果只有一条或没有记录，不需要清除
  if (histories.length <= 1) {
    return { success: true }
  }

  // 清除第二条记录（原来的栈顶）的快照
  const oldTopHistory = histories[1]  // ← 注意：是 histories[1]，不是 histories[0]
  if (oldTopHistory && oldTopHistory.fullContent !== null) {
    oldTopHistory.fullContent = null
    return await this.updateHistory(oldTopHistory)
  }
  return { success: true }
}
```

### 3. 添加调试日志

在关键位置添加 console.log，方便排查问题：
- 保存版本时：记录文章ID、内容长度、记录ID
- 重建内容时：记录目标索引、总记录数、每步操作
- 清除快照时：记录操作结果

## 修改的文件

1. ✅ `src/domains/editor/services/history.service.ts`
   - 调整 `saveNewVersion` 的操作顺序
   - 添加详细的调试日志

2. ✅ `src/shared/db/index.ts`
   - 修复 `clearOldTopSnapshot` 的逻辑
   - 清除第二条记录而不是第一条

## 测试验证

### 测试步骤：

1. **清除浏览器数据**
   - 打开开发者工具 → Application → IndexedDB
   - 删除 `musepocket_db` 数据库
   - 刷新页面（让数据库重新初始化）

2. **测试保存历史记录**
   - 输入一些文字，等待保存
   - 打开浏览器控制台，应该看到：
     ```
     [保存版本] 文章ID: xxx, 旧内容长度: 0, 新内容长度: 10
     [保存版本] 新记录已创建: xxx
     [保存版本] 清除旧快照: true
     ```
   - 继续输入，再次保存，查看日志

3. **测试历史版本列表**
   - 点击右侧"⏱️ 历史版本"按钮
   - 应该能看到历史记录列表
   - **不应该再出现"栈顶快照丢失"错误**

4. **测试 diff 预览**
   - 点击任意历史版本
   - 应该能看到 diff 对比窗口
   - 控制台应该输出：
     ```
     [重建内容] 文章ID: xxx, 目标索引: 1, 总记录数: 3
     [重建内容] 栈顶记录ID: xxx, 有快照: true
     [重建内容] 应用第 1 条 diff，当前内容长度: xxx
     [重建内容] 完成，最终内容长度: xxx
     ```

5. **测试撤销/重做**
   - 保存几次后，按 Ctrl+Z 撤销
   - 应该正常工作，不再报错

## 预期结果

✅ **不再出现"栈顶快照丢失"错误**
✅ **历史版本列表正常显示**
✅ **diff 预览正常工作**
✅ **撤销/重做功能正常**
✅ **控制台输出详细的调试信息**

## 原理说明

### 为什么只保留栈顶快照？

- **节省存储空间**：只有最新版本需要完整快照
- **减少冗余**：其他版本只需要 diff，可以通过栈顶快照重建

### 如何重建历史版本？

以 V0, V1, V2, V3 为例（V3 是最新）：

```
V3 (栈顶): fullContent = "当前内容"
V2: diffFromPrev = [V1 → V2 的 diff]
V1: diffFromPrev = [V0 → V1 的 diff]
V0: diffFromPrev = [初始 diff]
```

要重建 V1：
1. 从 V3.fullContent 开始 = "当前内容"
2. 反向应用 V3 的 diff → 得到 V2
3. 反向应用 V2 的 diff → 得到 V1 ✅

### 为什么要先创建再清除？

如果先清除再创建：
```
时刻 T1: 清除 V3 的 fullContent (V3 只有 diff)
时刻 T2: （还没创建 V4）
时刻 T3: 用户点击历史版本 → 读取数据库 → 栈顶没快照 ❌
时刻 T4: 创建 V4
```

先创建再清除：
```
时刻 T1: 创建 V4 (V4 有 fullContent) ✅
时刻 T2: （任何时候读取都有快照）
时刻 T3: 清除 V3 的 fullContent
```

## 注意事项

1. **数据库版本**
   - 确保使用的是 v4 版本的数据库
   - 如果从旧版本升级，可能需要清除数据

2. **调试日志**
   - 生产环境可以移除这些 console.log
   - 开发阶段保留有助于排查问题

3. **并发问题**
   - 当前实现是串行的
   - 如果需要支持高并发保存，需要加锁机制

# AI 返回内容思考块过滤功能

## 功能说明

一些推理模型（如 GLM-Z1-FlashX、DeepSeek 等）在返回内容时会包含 `<think>...</think>` 标签来展示模型的思考过程。这些思考内容虽然有助于理解模型的推理，但在实际应用中会影响最终显示效果。

本系统已自动实现了思考块的过滤功能，所有通过 `openaiFetch` 调用的 AI 接口都会自动清理返回内容中的思考块。

## 处理示例

### 原始返回内容

```json
{
  "choices": [
    {
      "message": {
        "content": "<think>\n这是模型的思考过程...\n用户说了你好，我应该友好回应...\n</think>\n你好！有什么我可以帮你的吗？"
      }
    }
  ]
}
```

### 处理后的内容

```json
{
  "choices": [
    {
      "message": {
        "content": "你好！有什么我可以帮你的吗？"
      }
    }
  ]
}
```

## 实现原理

在 `src/apis/index.ts` 中实现了 `cleanThinkTags` 函数：

```typescript
export function cleanThinkTags(content: string): string {
  if (!content) return content

  // 移除 <think>...</think> 标签及其内容（支持多行）
  return content.replace(/<think>[\s\S]*?<\/think>/gi, '').trim()
}
```

该函数会：
1. 使用正则表达式匹配所有的 `<think>...</think>` 标签
2. 支持多行内容（使用 `[\s\S]*?` 匹配任意字符包括换行）
3. 不区分大小写（使用 `i` 标志）
4. 移除标签及其包裹的所有内容
5. 清理多余的空白字符

## 影响范围

此功能自动应用于所有使用 `openaiFetch` 的功能模块：

- ✅ **校对工具**（ProofreadTool.vue）
- ✅ **取名工具**（NameGeneratorTool.vue）
- ✅ **实体提取**（EntityAiExtract.vue）
- ✅ **AI 接口测试**（SettingAiInterface.vue）
- ✅ **所有其他调用 AI 的功能**

## 兼容性

- ✅ 对于不包含思考块的模型，处理后内容保持不变
- ✅ 支持多个思考块（如果存在多个 `<think>` 标签）
- ✅ 支持嵌套和复杂的思考内容
- ✅ 不影响正常的 HTML 标签（因为使用精确匹配）

## 测试案例

### 案例 1：包含单个思考块

**输入：**
```
<think>
用户问好，需要礼貌回应
</think>
你好！很高兴为您服务。
```

**输出：**
```
你好！很高兴为您服务。
```

### 案例 2：包含多个思考块

**输入：**
```
<think>分析问题...</think>
第一部分回答
<think>继续思考...</think>
第二部分回答
```

**输出：**
```
第一部分回答
第二部分回答
```

### 案例 3：思考块在中间

**输入：**
```
开始部分<think>中间思考</think>结束部分
```

**输出：**
```
开始部分结束部分
```

### 案例 4：不包含思考块

**输入：**
```
这是正常的回答内容
```

**输出：**
```
这是正常的回答内容
```

## 注意事项

1. **自动处理**：开发者无需手动调用清理函数，系统会自动处理
2. **性能影响**：正则替换操作性能开销极小，不会影响用户体验
3. **安全性**：只处理标准的 `<think>` 标签，不会误删其他内容
4. **调试**：如果需要查看原始的思考内容，可以在 `openaiFetch` 中临时注释清理代码

## 未来扩展

如果需要保留思考内容用于调试或学习，可以考虑：
- 添加配置选项控制是否清理思考块
- 将思考内容保存到单独的字段
- 在开发模式下显示思考过程

---

更新时间：2025-12-11

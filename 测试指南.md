# 历史记录功能测试指南

## 修复内容

已修复以下问题：

1. ✅ **编辑器保存时传递旧内容**
   - 修改了 `Editor.vue`，现在会记录上次保存的内容
   - 保存时传递正确的 `oldText` 参数

2. ✅ **撤销/重做快捷键绑定**
   - `Ctrl+Z` 触发撤销
   - `Ctrl+Y` 触发重做
   - 快捷键事件正确传递给 EditPage

3. ✅ **历史记录生成逻辑**
   - 只有当内容真正改变时才生成历史记录
   - 空字符串也能正确生成第一条历史记录

## 测试步骤

### 1. 启动项目

项目已经在运行：http://localhost:5174/

### 2. 测试历史记录保存

1. 打开一个文章
2. 输入一些文字（例如："第一次修改"）
3. 等待 3 秒自动保存（或按 `Ctrl+S` 强制保存）
4. 继续输入更多文字（例如："第二次修改"）
5. 再次等待保存

### 3. 测试历史版本列表

1. 点击右侧工具栏的 **"⏱️ 历史版本"** 按钮
2. 应该能看到历史版本列表（按时间倒序）
3. 最新的记录在最上面，带有"快照"标记

### 4. 测试 Diff 预览

1. 在历史版本列表中，点击任意一个历史版本
2. 会弹出 Diff 对比窗口
3. 查看差异：
   - 绿色（+）= 回退后会新增的行
   - 红色（-）= 回退后会删除的行
   - 灰色 = 不变的行

### 5. 测试版本回退

1. 在 Diff 预览窗口中，点击 **"⬅️ 回退到此版本"** 按钮
2. 编辑器内容应该变成选中的历史版本
3. 检查历史版本列表，应该新增一条回退记录

### 6. 测试撤销/重做

1. 在编辑器中输入一些文字
2. 等待保存（或按 `Ctrl+S`）
3. 按 `Ctrl+Z` 撤销
   - 内容应该回到上一个版本
   - 应该显示提示："已撤销"
4. 按 `Ctrl+Y` 重做
   - 内容应该恢复到撤销前
   - 应该显示提示："已重做"

### 7. 测试工具栏按钮

1. 点击顶部工具栏的撤销按钮（⬅️）
2. 点击顶部工具栏的重做按钮（➡️）
3. 按钮应该在不可用时显示为禁用状态

## 预期结果

✅ **保存后能看到历史记录**
- 历史版本侧边栏不再是空白
- 每次保存都会生成新的历史版本

✅ **Ctrl+Z/Ctrl+Y 可以撤销重做**
- 快捷键响应正常
- 编辑器内容正确回退/重做

✅ **Diff 预览正确显示**
- 能看到版本之间的差异
- 差异方向符合用户预期

✅ **版本回退功能正常**
- 可以一次跳转到任意历史版本
- 回退操作会生成新的历史记录

## 调试信息

如果功能仍然不工作，请检查浏览器控制台（F12）的错误信息：

1. **检查是否有 diff 库的错误**
   - 应该能看到 `diff` 库正确导入

2. **检查历史记录是否保存到数据库**
   - 打开开发者工具 → Application → IndexedDB → musepocket_db
   - 查看 `articleHistories` 表是否有数据

3. **检查 saveArticle 调用**
   - 在控制台应该能看到 `oldText` 和 `newText` 的值
   - 添加 `console.log` 到 `saveArticle` 函数查看参数

## 问题排查

### 历史版本列表仍然为空

可能原因：
1. 数据库版本未升级 - 清除浏览器数据后重试
2. saveArticle 未被调用 - 检查编辑器事件绑定
3. diff 为空 - 内容未改变时不会生成记录

### 撤销/重做无反应

可能原因：
1. 历史记录列表为空 - 先保存几次生成历史记录
2. 事件未绑定 - 检查 Editor 组件的 @undo/@redo 绑定
3. currentIndex 状态错误 - 查看 history.store 的状态

### Diff 显示异常

可能原因：
1. diff 库未安装 - 运行 `npm install diff`
2. 内容清洗不一致 - 检查 getCleanedEditorContent 函数
3. 行号错误 - 查看 convertToVisualDiff 函数

## 下一步优化

如果基本功能正常，可以考虑：

1. 添加版本数量限制（避免无限增长）
2. 优化长文本 diff 性能
3. 添加版本标签/备注功能
4. 实现版本压缩/合并
